@page "/xml-loading"
@using System.Xml.Linq
@inject IJSRuntime JSRuntime
@inject SharedDataService SharedDataService

<h3>Wczytywanie i zapisywanie pliku XML (lokalnie przez u¿ytkownika)</h3>

<!-- Sekcja: Wybór pliku XML -->
<InputFile OnChange="OnFileSelected" />

@if (!string.IsNullOrEmpty(fileName))
{
    SharedDataService.FileName = fileName;
}

@if (SharedDataService.Pairs.Count > 0)
{
    <h5 class="mt-3">Za³adowany plik: @SharedDataService.FileName</h5>
    <h5 class="mt-4">Lista za³adowanych par:</h5>
    <ul>
        @foreach (var pair in SharedDataService.Pairs)
        {
            <li>
                <button class="btn btn-sm btn-danger ms-2" @onclick="() => RemovePair(pair)">X</button>
                @pair.FrontSide - @pair.BackSide
            </li>
        }
    </ul>
}

<!-- Sekcja: Dodawanie nowej pary -->
<div class="mt-3">
    <input @bind="newFront" placeholder="Wpisz front-side..." />
    <input @bind="newBack" placeholder="Wpisz back-side..." />
    <button class="btn btn-info" @onclick="AddPair">Dodaj parê</button>
</div>

@if (SharedDataService.Pairs.Count > 0)
{
    <button class="btn btn-success mt-3" @onclick="SaveToXml">
        Pobierz zmodyfikowany plik XML
    </button>
}

@code {
    private string newFront = "";
    private string newBack = "";
    private string? fileName;

    private async Task OnFileSelected(InputFileChangeEventArgs e)
    {
        var file = e.GetMultipleFiles(1).FirstOrDefault();
        if (file == null) return;

        fileName = file.Name;
        using var stream = file.OpenReadStream(maxAllowedSize: 10_000_000);
        using var reader = new StreamReader(stream);
        var xmlContent = await reader.ReadToEndAsync();

        SharedDataService.LoadPairsFromXml(xmlContent);
    }

    private void AddPair()
    {
        if (!string.IsNullOrWhiteSpace(newFront) && !string.IsNullOrWhiteSpace(newBack))
        {
            SharedDataService.Pairs.Add(new SharedDataService.FlashcardPair
                {
                    FrontSide = newFront,
                    BackSide = newBack
                });

            newFront = "";
            newBack = "";
        }
    }

    private void RemovePair(SharedDataService.FlashcardPair pair)
    {
        SharedDataService.Pairs.Remove(pair);
    }

    private async Task SaveToXml()
    {
        var xmlString = SharedDataService.GetXmlFromPairs();
        await JSRuntime.InvokeVoidAsync("saveFileWithPicker", xmlString, "application/xml");
    }
}
