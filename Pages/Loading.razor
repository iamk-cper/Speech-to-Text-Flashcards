@page "/xml-loading"
@using System.Xml.Linq
@inject IJSRuntime JSRuntime
@inject SharedDataService SharedDataService

<h3>Wczytywanie i zapisywanie pliku XML (lokalnie przez u¿ytkownika)</h3>

<!-- Sekcja: Wybór pliku XML -->
<InputFile OnChange="OnFileSelected" />

@if (!string.IsNullOrEmpty(fileName))
{
    SharedDataService.fileName = fileName;
}

<!-- Sekcja: Lista par wczytanych z pliku -->
@if (SharedDataService.Pairs.Count > 0)
{
    <h5 class="mt-3">Za³adowany plik: @SharedDataService.fileName</h5>
    <h5 class="mt-4">Lista za³adowanych par:</h5>
    <ul>
        @foreach (var pair in SharedDataService.Pairs)
        {
            <li>
                <button class="btn btn-sm btn-danger ms-2" @onclick="() => RemovePair(pair)">X</button>
                @pair.FrontSide - @pair.BackSide
            </li>
        }
    </ul>
}

<!-- Sekcja: Dodawanie nowej pary -->
<div class="mt-3">
    <input @bind="newFront" placeholder="Wpisz front-side..." />
    <input @bind="newBack" placeholder="Wpisz back-side..." />
    <button class="btn btn-info" @onclick="AddPair">Dodaj parê</button>
</div>

<!-- Sekcja: Zapisywanie do pliku -->
@if (SharedDataService.Pairs.Count > 0)
{
    <button class="btn btn-success mt-3" @onclick="SaveToXml">Pobierz zmodyfikowany plik XML</button>
}

@code {
    private string newFront = "";
    private string newBack = "";
    private string? fileName;

    private async Task OnFileSelected(InputFileChangeEventArgs e)
    {
        var file = e.GetMultipleFiles(1).FirstOrDefault();
        if (file == null) return;

        fileName = file.Name;

        using var stream = file.OpenReadStream(maxAllowedSize: 10_000_000);
        using var reader = new StreamReader(stream);
        var xmlContent = await reader.ReadToEndAsync();

        LoadPairsFromXml(xmlContent);
    }

    private void LoadPairsFromXml(string xml)
    {
        SharedDataService.Pairs.Clear();

        try
        {
            var xdoc = XDocument.Parse(xml);
            foreach (var el in xdoc.Descendants("pair"))
            {
                var front = el.Element("front")?.Value;
                var back = el.Element("back")?.Value;

                if (!string.IsNullOrEmpty(front) && !string.IsNullOrEmpty(back))
                {
                    SharedDataService.Pairs.Add(new SharedDataService.FlashcardPair
                    {
                        FrontSide = front,
                        BackSide = back
                    });
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine("B³¹d parsowania XML: " + ex.Message);
        }
    }

    private void AddPair()
    {
        if (!string.IsNullOrWhiteSpace(newFront) && !string.IsNullOrWhiteSpace(newBack))
        {
            SharedDataService.Pairs.Add(new SharedDataService.FlashcardPair
            {
                FrontSide = newFront,
                BackSide = newBack
            });

            newFront = "";
            newBack = "";
        }
    }

    private void RemovePair(SharedDataService.FlashcardPair pair)
    {
        SharedDataService.Pairs.Remove(pair);
    }

    private async Task SaveToXml()
    {
        var xdoc = new XDocument(
            new XElement("pairs",
                from p in SharedDataService.Pairs
                select new XElement("pair",
                    new XElement("front", p.FrontSide),
                    new XElement("back", p.BackSide)
                )
            )
        );

        var xmlString = xdoc.ToString();
        await JSRuntime.InvokeVoidAsync("saveFileWithPicker", xmlString);
    }
}
